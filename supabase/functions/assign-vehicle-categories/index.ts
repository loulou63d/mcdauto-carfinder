import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-supabase-client-platform, x-supabase-client-platform-version, x-supabase-client-runtime, x-supabase-client-runtime-version",
};

// Category detection mapping based on model/brand keywords
const CATEGORY_KEYWORDS = {
  "SUV": ["suv", "sport utility", "x1", "x2", "x3", "x4", "x5", "x6", "x7", "q3", "q5", "q7", "q8", "gle", "glc", "gle", "glb", "g-class", "ml", "rav4", "highlander", "venza", "vios", "hiace", "fortuner", "grand vitara", "vitara", "swift", "sx4", "vitara brezza", "ertiga", "xv", "crosstrek", "outback", "forester", "impreza", "legacy", "wrx", "liberty", "sorento", "niro", "sportage", "seltos", "carnival", "cerato", "forte", "optima", "sonata", "tucson", "santa fe", "creta", "venue", "kona", "santa fe", "palisade", "ioniq", "ioniq 5", "ioniq 6", "ioniq 7", "kicks", "qashqai", "x-trail", "rogue", "murano", "pathfinder", "frontier", "duster", "sandero", "lodgy", "dokker", "jogger", "clio", "scenic", "megane", "arkana", "captur", "koleos", "austral", "espace", "karoq", "superb", "octavia", "fabia", "rapid", "citigo", "polo", "golf", "tiguan", "touareg", "taos", "id.buzz", "id.4", "id.5", "t-roc", "t-cross", "arteon", "passat", "jetta", "gol", "voyage", "caratinga", "montana", "tracker", "equinox", "traverse", "tahoe", "suburban", "silverado", "sierra", "ranger", "f-150", "f-250", "f-350", "escape", "edge", "explorer", "expedition", "mustang mach-e", "focus", "fiesta", "fusion", "mondeo", "s-max", "galaxy", "transit", "transit connect", "transit custom", "transit courier", "e-transit", "transit trail", "transit connect", "transit custom", "fiat 500x", "fiat 600", "jeep wrangler", "jeep cherokee", "jeep grand cherokee", "jeep gladiator", "jeep compass", "jeep renegade", "jeep avenger", "renegade", "compass", "wrangler", "cherokee", "grand cherokee", "gladiator", "avenger", "porsche macan", "macan", "macan s", "macan turbo", "macan electric", "porsche cayenne", "cayenne", "cayenne e-hybrid", "cayenne s", "cayenne turbo", "porsche panamera", "panamera", "porsche 911", "911", "911 carrera", "911 turbo", "911 gt2", "911 gt3", "audi a1", "a3", "a4", "a5", "a6", "a8", "a7", "a8l", "q2", "q3", "q4 e-tron", "q5", "q7", "q8", "tt", "tts", "r8", "rs 3", "rs 4", "rs 5", "rs 6", "rs 7", "bmw 118i", "120i", "125i", "m135i", "220i", "230i", "m240i", "320i", "325i", "330i", "m340i", "420i", "430i", "m440i", "520i", "530i", "540i", "m550i", "640i", "650i", "m650i", "730i", "740i", "750i", "760i", "m760i", "alpina", "m3", "m4", "m5", "m6", "m7", "m8", "x1", "x2", "x3", "x4", "x5", "x6", "x7", "ix1", "ix2", "ix3", "ix xdrive 40", "ix xdrive 50", "ix m60", "ix m70", "x1 m40i", "x2 m35i", "x3 m40i", "x4 m40i", "x5 m40i", "x6 m40i", "x7 m50i", "mini cooper", "clubman", "countryman", "paceman", "jcw", "electric", "se", "tesla model x", "tesla model y", "tesla roadster", "tesla cybertruck", "tesla semi", "lamborghini urus", "urus", "lamborghini revuelto", "revuelto", "lotus emira", "emira", "lotus eletre", "eletre", "mclaren artura", "artura", "mclaren gt", "mclaren 720s", "mclaren 765lt", "mclaren senna", "rolls-royce", "bentley", "bugatti", "ferrari", "pagani", "koenigsegg"],
  "4x4": ["4x4", "4wd", "four-wheel drive", "jeep wrangler", "wrangler", "land rover defender", "defender", "land rover discovery", "discovery", "range rover", "range rover sport", "range rover evoque", "evoque", "range rover velar", "velar", "pajero", "montero", "outlander", "lancer", "pajero sport", "shogun", "delica", "isuzu", "d-max", "mux", "isuzu rodeo", "isuzu trooper", "isuzu wizard", "isuzu dmax", "mahindra", "bolero", "xuv500", "xuv700", "thar", "mahindra xuv", "ssangyong", "rexton", "kyron", "actyon", "korando", "tivoli", "musso", "fiat type 4x4", "jeep rubicon", "jeep wrangler rubicon", "wrangler rubicon", "wrangler tj", "wrangler jk", "wrangler jl"],
  "Break": ["break", "combi", "estate", "station wagon", "touring", "alltrack", "outback", "legacy", "forester", "impreza", "crosstrek", "volvo v40", "v60", "v90", "v90 cross country", "v60 cross country", "v40 cross country", "v90 cc", "v60 cc", "v40 cc", "xc40", "xc60", "xc70", "xc80", "xc90", "s60 cross country", "s90", "polestar 2", "polestar 3", "polestar performance", "audi a4 avant", "a6 avant", "a8 avant", "s4 avant", "s6 avant", "s8 avant", "rs4 avant", "rs6 avant", "rs8 avant", "skoda superb", "octavia", "karoq", "fabia", "combi", "octavia combi", "fabia combi", "superb combi", "mercedes c63 amg wagon", "e63 amg wagon", "glc", "gle", "gls", "glb", "glk", "gle coupe", "bmw 320i touring", "330i touring", "340i touring", "330d touring", "340d touring", "328d touring", "335d touring", "435d touring", "440i touring", "540i touring", "550i touring", "m340i xdrive touring", "m440i xdrive touring", "m550i xdrive touring", "ford mondeo estate", "focus estate", "fusion hybrid", "peugeot 508", "3008", "5008", "308 sw", "5008 gt", "ds 7", "ds 9", "renault espace", "laguna", "scenic", "megane sporter", "talisman", "grand scenic", "alaskan", "master", "kangoo", "grand modus", "modus", "scenic iv", "grand scenic iv", "megane estate", "megane sporter", "scenic sporter", "talisman estate", "laguna estate", "espace estate", "grand modus", "modus", "kia cee'd sw", "optima", "sorento", "carnival", "carens", "niro", "sportage", "seltos", "telluride", "hyundai i30", "i40", "santa fe", "tucson", "palisade", "venue", "kona", "ioniq", "ioniq 6", "ioniq 7", "toyota corolla touring", "corolla hybrid", "corolla adventure", "matrix", "venza", "highlander", "4runner", "rav4", "rav4 prime", "rav4 hybrid", "rav4 adventure", "sienna", "highlander hybrid", "sequoia", "tundra", "tacoma", "t100", "toyota carina", "camry", "celica", "corona", "corolla", "cressida", "crown", "curren", "dyna", "estima", "fortuner", "hiace", "highlander hybrid", "hilux", "mark x", "mark ii", "mark iii", "mark iv", "matrix", "mirai", "mr2", "paseo", "previa", "prius", "prius prime", "prius plug-in", "prius c", "prius v", "prius alpha", "rav4", "rav4 prime", "reitz", "revolution", "rush", "s-fr", "scion fr-s", "scion xa", "scion xb", "scion xd", "sera", "sienna", "soarer", "solara", "spacio", "sprinter", "starlet", "supra", "ist", "wish", "yaris", "yaris hybrid", "yaris verso", "yaris cross", "yaris gr", "yaris gr sport", "yaris cross hybrid", "yaris gr circuit trail", "yaris gr rally", "yaris gr gt", "yaris gr circuit trail", "yes", "zero premium", "genesis", "infiniti", "hyundai genesis", "equus"],
  "Berline": ["berline", "sedan", "saloon", "touring", "limo", "limousine", "dci", "tdi", "crdi", "tdci", "vti", "vts", "vti-k", "e-tense", "phev", "hybrid", "diesel", "essence", "gasolina", "essence flex", "gasolina flex", "flex fuel", "audi a3", "a4", "a5", "a6", "a7", "a8", "a8l", "rs3", "rs4", "rs5", "rs6", "rs7", "bmw 118i", "120i", "125i", "320i", "328i", "330i", "335i", "340i", "420i", "430i", "440i", "520i", "525i", "528i", "530i", "535i", "540i", "545i", "550i", "m340i", "m440i", "m550i", "m760i", "m3", "m4", "m5", "m6", "m7", "m8", "alpina", "i7", "i5", "i3", "i4", "mercedes c180", "c200", "c220", "c250", "c300", "c350", "c63 amg", "e200", "e220", "e250", "e280", "e300", "e350", "e63 amg", "e65", "e200d", "e220d", "e250d", "e280d", "e300d", "e350d", "e400", "e420", "e500", "e550", "e63", "s500", "s550", "s600", "s65 amg", "s63 amg", "s65", "cl500", "cl550", "cl600", "cl63", "cl65", "cla180", "cla200", "cla220", "cla250", "cla45 amg", "cla45", "cln", "clr", "cls300", "cls350", "cls400", "cls500", "cls550", "cls63", "cls65", "cls amg", "slk200", "slk250", "slk300", "slk350", "slk55", "slk63", "sl300", "sl350", "sl500", "sl550", "sl600", "sl63", "sl65", "s4", "s6", "s8", "rs4", "rs5", "rs6", "rs7", "rs8", "s3", "volkswagen passat", "jetta", "golf", "scirocco", "corrado", "phaeton", "tiguan", "touareg", "taos", "id.", "id.4", "id.5", "id.buzz", "t-cross", "t-roc", "caddy", "golf r", "golf gti", "golf gte", "golf etron", "jetta hybrid", "jetta gli", "passat hybrid", "arteon", "cc", "eos", "gti", "gli", "gt", "jetta sport", "jetta s", "jetta se", "jetta gli", "jetta r-line", "jetta hybrid", "jetta tsi", "jetta 1.6", "jetta 1.8", "jetta 2.0", "jetta 2.5", "jetta 3.0", "jetta 3.5", "jetta 4.2", "jetta gli 1.8t", "jetta gli 2.0", "jetta gli 2.5", "jetta gli sport", "jetta r-line", "jetta se sport", "passat 1.6", "passat 1.8", "passat 2.0", "passat 2.3", "passat 2.5", "passat 3.0", "passat 3.5", "passat 3.6", "passat 4.0", "passat 4.2", "passat v6", "passat v8", "passat w8", "passat tsi", "passat tdi", "passat hybrid", "passat gte", "passat gte hybrid", "passat gte plug-in", "jetta sedan", "passat sedan", "cc sedan", "eos sedan", "phaeton sedan", "ford focus", "fiesta", "fusion", "mondeo", "escort", "tempo", "contour", "taurus", "galaxie", "mustang", "pinto", "fairmont", "zephyr", "thunderbird", "fairlane", "torino", "gran torino", "ltd", "torino", "cortina", "capri", "cosworth", "escort cosworth", "scorpio", "sierra", "granada", "consul", "cortina", "mk1", "mk2", "mk3", "mk4", "mk5", "mk6", "mk7", "mk8", "mk9", "mk10", "mk11", "mk12", "focus 1.0", "focus 1.4", "focus 1.5", "focus 1.6", "focus 1.8", "focus 2.0", "focus 2.3", "focus 2.5", "focus rs", "focus st", "focus se", "focus s", "focus zx3", "focus zx5", "focus cosworth", "fiesta 1.0", "fiesta 1.4", "fiesta 1.5", "fiesta 1.6", "fiesta 1.7", "fiesta 2.0", "fiesta st", "fiesta rs", "fiesta se", "fiesta s", "fiesta zx2", "fiesta cosworth", "fusion hybrid", "fusion plug-in hybrid", "fusion sport", "fusion se", "fusion s", "fusion titanium", "mondeo 1.0", "mondeo 1.5", "mondeo 1.6", "mondeo 1.8", "mondeo 2.0", "mondeo 2.3", "mondeo 2.5", "mondeo 3.0", "mondeo st", "mondeo rs", "mondeo se", "mondeo s", "mondeo titanium"],
  "Coupé": ["coupe", "coupé", "coupe sport", "sport coupe", "2 portes", "deux portes", "2 door", "two-door", "mustang", "camaro", "challenger", "charger", "firebird", "trans am", "gto", "ls", "ss", "chevelle", "nova", "impala", "chevrolet camaro", "camaro", "camaro ss", "camaro rs", "camaro z28", "camaro zl1", "camaro z/28", "chevrolet corvette", "corvette", "corvette c5", "corvette c6", "corvette c7", "corvette c8", "corvette stingray", "corvette z06", "corvette zr2", "corvette zo6", "corvette 427", "corvette 427 sc", "corvette 350", "corvette 350 sc", "corvette 383", "corvette 427 super charged", "corvette 427 zo6", "corvette 427 z06", "dodge charger", "charger r/t", "charger srt8", "charger srt 392", "charger srt8 396", "charger srt8 440", "dodge challenger", "challenger r/t", "challenger srt8", "challenger srt 392", "challenger srt8 392", "challenger srt8 440", "dodge coronet", "coronet rt", "coronet gts", "dodge dart", "dart gts", "dart gt", "dodge polara", "polara rt", "dodge 330", "dodge 440", "dodge super bee", "super bee", "dodge super bee 383", "dodge super bee 440", "ford mustang", "mustang", "mustang fastback", "mustang gt", "mustang gt500", "mustang mach 1", "mustang mach e", "mustang gt350", "mustang gt350r", "mustang gt500", "mustang cobra", "mustang cobra jet", "mustang boss", "mustang boss 302", "mustang boss 429", "mustang shelby", "mustang shelby gt350", "mustang shelby gt500", "mustang fastback", "mustang bullitt", "pontiac gto", "gto", "gto judge", "pontiac firebird", "firebird", "firebird trans am", "firebird formula", "buick skylark", "skylark gsx", "buick regal", "regal gsx", "oldsmobile cutlass", "cutlass supreme", "cutlass 442", "oldsmobile 442", "oldsmobile vista cruiser", "oldsmobile 4-4-2", "oldsmobile vista", "oldsmobile delta 88", "oldsmobile toronado", "oldsmobile tornado", "oldsmobile f-85", "oldsmobile jetfire", "oldsmobile swinger", "oldsmobile supreme", "oldsmobile hurst/olds", "oldsmobile hurst", "oldsmobile 442", "oldsmobile 455", "oldsmobile rallye 350", "oldsmobile rallye 455", "pontiac gto judge", "pontiac gto 455", "pontiac gto 400", "pontiac gto 389", "pontiac grand am", "pontiac grand prix", "pontiac bonneville", "pontiac catalina", "pontiac 2+2", "pontiac tempest", "pontiac lemans", "pontiac ventura", "pontiac sunbird", "pontiac fiero", "pontiac grand am gt", "pontiac grand prix gtp", "pontiac grand prix stp", "plymouth cuda", "cuda", "cuda 340", "cuda 383", "cuda 426", "cuda 440", "plymouth road runner", "road runner", "road runner 383", "road runner 426", "road runner 440", "plymouth satellite", "satellite gts", "plymouth superbird", "superbird", "plymouth gtx", "gtx", "gtx 426", "gtx 440", "amc gremlin", "gremlin", "amc javelin", "javelin", "javelin amc", "javelin sst", "amc rebel", "rebel sst", "amc matador", "matador", "amc hornet", "hornet", "amc concord", "concord", "amc spirit", "spirit", "amc pacer", "pacer", "studebaker hawk", "hawk", "studebaker avanti", "avanti", "amc amx", "amx", "amc amx sst", "amc amx gt", "amc amx super performance", "kaiser darrin", "darrin", "kaiser-darrin", "willys jeepster", "jeepster", "honda civic", "civic si", "civic type r", "civic gsi", "civic coupe", "civic si coupe", "civic ex coupe", "civic dx coupe", "civic lx coupe", "civic type r coupe", "civic type r ep", "civic type r ep3", "civic type r fn2", "honda crx", "crx si", "honda accord", "accord coupe", "accord ex coupe", "accord dx coupe", "accord lx coupe", "accord si coupe", "accord v6 coupe", "honda prelude", "prelude si", "prelude vtec", "hyundai tiburon", "tiburon", "hyundai coupe", "tiburon coupe", "hyundai fx", "hyundai tuscani", "hyundai scoupe", "hyundai s coupe", "kia sportage", "kia forte koup", "kia optima", "kia optima coupe", "mazda miata", "miata", "miata mx5", "mazda rx7", "rx7", "rx7 fd", "rx7 fd3s", "rx7 series 1", "rx7 series 2", "rx7 series 3", "rx7 series 4", "rx7 series 5", "rx7 series 6", "rx7 series 7", "rx7 series 8", "mazda rx8", "rx8", "mazda3 coupe", "mazda5 coupe", "mazda6 coupe", "mazda626 coupe", "mazda mx6", "mx6", "mazda capella", "mazda cosmo", "mazda luce", "mazda carol", "mazda familia", "mazda etude", "mazda 323", "mazda 626", "mazda 929", "subaru brz", "brz", "subaru impreza wrx sti", "impreza wrx", "impreza wrx sti", "impreza coupe", "subaru svx", "svx", "subaru legacy", "legacy coupe", "toyota mr2", "mr2", "mr2 spyder", "mr2 turbo", "toyota supra", "supra", "supra turbo", "toyota 2000gt", "2000gt", "2000 gt", "toyota celica", "celica", "celica gt", "celica gt4", "celica gts", "toyota corolla", "corolla", "corolla ae86", "corolla gts", "corolla fx", "corolla fxgt", "corolla levin", "corolla trueno", "corolla kp60", "corolla ke70", "corolla a60", "corolla te72", "corolla te71", "corolla ta60", "corolla te61", "corolla ta50", "corolla ke30", "corolla ke20", "corolla ke10", "corolla ke15", "corolla kp50", "nissan 300zx", "300zx", "300zx z31", "300zx z32", "nissan 370z", "370z", "370z nismo", "nissan z", "nissan fairlady z", "fairlady z", "fairlady z s30", "fairlady z s130", "fairlady z z31", "fairlady z z32", "fairlady z z33", "fairlady z z34", "nissan 240sx", "240sx", "240sx s13", "240sx s14", "240sx s15", "nissan silvia", "silvia", "silvia s13", "silvia s14", "silvia s15", "silvia s110", "silvia s12", "silvia s11", "nissan pulsar", "pulsar gti-r", "pulsar gtir", "nissan primera", "primera coupe", "nissan sunny", "sunny gti-r", "sunny gtir", "nissan sentra", "sentra gti", "nissan datsun", "datsun", "datsun 280z", "datsun 240z", "datsun 260z", "datsun 200sx", "datsun 510", "datsun 610", "datsun 710", "datsun 810", "datsun bluebird", "datsun gazelle", "datsun cherry", "datsun laurel", "datsun maxima", "datsun cedric", "datsun gloria", "datsun skyline", "datsun skyline gt-r", "datsun gtr", "datsun kgc10", "datsun kgc110", "datsun hc110", "datsun jh110", "datsun lc110", "datsun pc110", "datsun ps110", "datsun r380", "datsun j1600", "datsun bluebird sss", "datsun fairlady", "datsun fairlady z", "datsun bluebird 1600sss", "datsun roadster", "datsun sports", "datsun 1200", "datsun 1000", "datsun sunny", "datsun cherry e-vro", "datsun go", "datsun redi-go", "bmw 318is", "318is coupe", "bmw 320is", "320is coupe", "bmw 325is", "325is coupe", "bmw 328is", "328is coupe", "bmw 335is", "335is coupe", "bmw m3 coupe", "m3 coupe", "m3 e30", "m3 e36", "m3 e46", "m3 e92", "m3 e93", "m3 f80", "m3 f83", "m3 g80", "m3 g82", "m3 g87", "bmw 630cs", "630cs coupe", "bmw 633csi", "633csi coupe", "bmw 635csi", "635csi coupe", "bmw 640i", "640i coupe", "bmw 645ci", "645ci coupe", "bmw 650i", "650i coupe", "bmw 840ci", "840ci coupe", "bmw 850ci", "850ci coupe", "bmw 850csi", "850csi coupe", "bmw m6", "m6 coupe", "m6 e24", "m6 e63", "m6 e64", "m6 f06", "m6 f12", "m6 f13", "m6 g15", "bmw m635csi", "m635csi coupe", "audi 80", "80 coupe", "audi 90", "90 coupe", "audi s2", "s2 coupe", "audi s4", "s4 coupe", "audi s5", "s5 coupe", "audi s6", "s6 coupe", "audi s7", "s7 coupe", "audi s8", "s8 coupe", "audi rs2", "rs2 coupe", "audi rs3", "rs3 coupe", "audi rs4", "rs4 coupe", "audi rs5", "rs5 coupe", "audi rs6", "rs6 coupe", "audi rs7", "rs7 coupe", "audi rs8", "rs8 coupe", "audi 100", "100 coupe", "audi 200", "200 coupe", "audi a4", "a4 coupe", "audi a5", "a5 coupe", "audi a6", "a6 coupe", "audi a7", "a7 coupe", "audi a8", "a8 coupe", "audi cabriolet", "cabriolet coupe", "audi tt", "tt coupe", "audi a1", "a1 coupe", "audi a2", "a2 coupe", "mercedes slk", "slk coupe", "mercedes sl", "sl coupe", "mercedes slc", "slc coupe", "mercedes 380sl", "380sl coupe", "mercedes 500sl", "500sl coupe", "mercedes 560sl", "560sl coupe", "mercedes 200", "200 coupe", "mercedes 230", "230 coupe", "mercedes 250", "250 coupe", "mercedes 280", "280 coupe", "mercedes 300", "300 coupe", "mercedes 320", "320 coupe", "mercedes 350", "350 coupe", "mercedes 380", "380 coupe", "mercedes 420", "420 coupe", "mercedes 500", "500 coupe", "mercedes 560", "560 coupe", "mercedes 600", "600 coupe", "porsche 911", "911 coupe", "porsche 912", "912 coupe", "porsche 914", "914 coupe", "porsche 916", "916 coupe", "porsche 924", "924 coupe", "porsche 944", "944 coupe", "porsche 968", "968 coupe", "porsche 928", "928 coupe", "porsche 929", "929 coupe", "porsche 930", "930 coupe", "porsche 931", "931 coupe", "porsche 932", "932 coupe", "porsche 933", "933 coupe", "porsche 934", "934 coupe", "porsche 935", "935 coupe", "porsche 936", "936 coupe", "porsche 962", "962 coupe", "porsche 964", "964 coupe", "porsche 993", "993 coupe", "porsche 996", "996 coupe", "porsche 997", "997 coupe", "porsche 991", "991 coupe", "porsche 992", "992 coupe", "porsche turbo", "porsche turbo coupe", "porsche carrera", "porsche carrera coupe", "porsche gt", "porsche gt coupe", "porsche gt2", "porsche gt2 coupe", "porsche gt3", "porsche gt3 coupe", "porsche gt4", "porsche gt4 coupe", "ferrari 308", "308 coupe", "ferrari 328", "328 coupe", "ferrari 355", "355 coupe", "ferrari 360", "360 coupe", "ferrari 430", "430 coupe", "ferrari 458", "458 coupe", "ferrari 488", "488 coupe", "ferrari f8", "f8 coupe", "ferrari f12", "f12 coupe", "ferrari 599", "599 coupe", "ferrari ff", "ff coupe", "ferrari gtc4lusso", "gtc4lusso coupe", "ferrari 812", "812 coupe", "ferrari sf90", "sf90 coupe", "lamborghini gallardo", "gallardo coupe", "lamborghini murciélago", "murciélago coupe", "lamborghini reventon", "reventon coupe", "lamborghini aventador", "aventador coupe", "lamborghini sesto elemento", "sesto elemento coupe", "lamborghini egoista", "egoista coupe", "lamborghini huracán", "huracán coupe", "maserati 3500gt", "3500gt coupe", "maserati ghibli", "ghibli coupe", "maserati bora", "bora coupe", "maserati merak", "merak coupe", "maserati kyalami", "kyalami coupe", "maserati biturbo", "biturbo coupe", "maserati quattroporte", "quattroporte coupe", "maserati spyder", "spyder coupe", "maserati mc12", "mc12 coupe", "maserati granturismo", "granturismo coupe", "maserati grancabrio", "grancabrio coupe", "maserati levante", "levante coupe", "rolls-royce phantom", "phantom coupe", "rolls-royce ghost", "ghost coupe", "rolls-royce wraith", "wraith coupe", "rolls-royce dawn", "dawn coupe", "rolls-royce corniche", "corniche coupe", "bentley continental", "continental coupe", "bentley arnage", "arnage coupe", "bentley azure", "azure coupe", "bentley brooklands", "brooklands coupe", "bugatti veyron", "veyron coupe", "bugatti chiron", "chiron coupe", "koenigsegg ccx", "ccx coupe", "koenigsegg cc8s", "cc8s coupe", "koenigsegg agera", "agera coupe", "koenigsegg jesko", "jesko coupe", "pagani zonda", "zonda coupe", "pagani huayra", "huayra coupe", "lotus esprit", "esprit coupe", "lotus emira", "emira coupe", "mclaren f1", "f1 coupe", "mclaren mp4-12c", "mp4-12c coupe", "mclaren 570s", "570s coupe", "mclaren 540c", "540c coupe", "mclaren 570gt", "570gt coupe", "mclaren 720s", "720s coupe", "mclaren artura", "artura coupe"],
  "Cabriolet": ["cabriolet", "convertible", "roadster", "spider", "spyder", "drop top", "soft top", "hardtop", "retractable", "porsche 911 cabriolet", "911 cabriolet", "porsche 911 turbo cabriolet", "911 turbo cabriolet", "porsche 911 carrera cabriolet", "911 carrera cabriolet", "porsche 911 targa", "911 targa", "porsche 911 speedster", "911 speedster", "porsche boxster", "boxster", "porsche boxster s", "boxster s", "porsche boxster gts", "boxster gts", "porsche cayman", "cayman", "porsche cayman s", "cayman s", "porsche cayman gts", "cayman gts", "mercedes slk", "slk cabriolet", "mercedes cl", "cl cabriolet", "mercedes sl", "sl cabriolet", "mercedes slr", "slr cabriolet", "mercedes sls", "sls cabriolet", "mercedes c63 amg cabriolet", "c63 amg cabriolet", "mercedes e63 amg cabriolet", "e63 amg cabriolet", "mercedes gle63 amg cabriolet", "gle63 amg cabriolet", "bmw m440i cabriolet", "m440i cabriolet", "bmw m440i xdrive cabriolet", "m440i xdrive cabriolet", "bmw m450i xdrive cabriolet", "m450i xdrive cabriolet", "bmw m4 cabriolet", "m4 cabriolet", "bmw m3 cabriolet", "m3 cabriolet", "bmw 335is cabriolet", "335is cabriolet", "bmw 340i cabriolet", "340i cabriolet", "bmw 330i cabriolet", "330i cabriolet", "bmw 320i cabriolet", "320i cabriolet", "bmw 318i cabriolet", "318i cabriolet", "bmw 316i cabriolet", "316i cabriolet", "bmw 635csi cabriolet", "635csi cabriolet", "bmw 633csi cabriolet", "633csi cabriolet", "bmw 630cs cabriolet", "630cs cabriolet", "bmw 745i cabriolet", "745i cabriolet", "bmw 740i cabriolet", "740i cabriolet", "bmw 735i cabriolet", "735i cabriolet", "bmw 730i cabriolet", "730i cabriolet", "bmw 650i cabriolet", "650i cabriolet", "bmw 645ci cabriolet", "645ci cabriolet", "bmw 640i cabriolet", "640i cabriolet", "bmw 850ci cabriolet", "850ci cabriolet", "bmw 840ci cabriolet", "840ci cabriolet", "bmw m850i cabriolet", "m850i cabriolet", "bmw m840i cabriolet", "m840i cabriolet", "bmw 750i cabriolet", "750i cabriolet", "bmw 760i cabriolet", "760i cabriolet", "audi rs5 cabriolet", "rs5 cabriolet", "audi s5 cabriolet", "s5 cabriolet", "audi a5 cabriolet", "a5 cabriolet", "audi a4 cabriolet", "a4 cabriolet", "audi s4 cabriolet", "s4 cabriolet", "audi tt roadster", "tt roadster", "audi tt cabriolet", "tt cabriolet", "audi a3 cabriolet", "a3 cabriolet", "audi cabriolet", "cabriolet", "jaguar f-type", "f-type cabriolet", "jaguar xk", "xk cabriolet", "jaguar xkr", "xkr cabriolet", "jaguar xe cabriolet", "xe cabriolet", "jaguar e-type", "e-type cabriolet", "jaguar type-e", "type-e cabriolet", "rolls-royce phantom drophead coupe", "phantom drophead coupe", "rolls-royce corniche", "corniche cabriolet", "bentley continental gt convertible", "continental gt convertible", "bentley azure", "azure cabriolet", "bentley arnage cabriolet", "arnage cabriolet", "ferrari 458 spider", "458 spider", "ferrari 458 italia spider", "458 italia spider", "ferrari f8 tributo spider", "f8 tributo spider", "ferrari 488 spider", "488 spider", "ferrari 488 pista spider", "488 pista spider", "ferrari sf90 spider", "sf90 spider", "ferrari 812 gts", "812 gts", "ferrari ff cabriolet", "ff cabriolet", "ferrari gtc4lusso cabriolet", "gtc4lusso cabriolet", "lamborghini reventon roadster", "reventon roadster", "lamborghini murciélago roadster", "murciélago roadster", "lamborghini gallardo spyder", "gallardo spyder", "lamborghini huracán spyder", "huracán spyder", "lamborghini aventador roadster", "aventador roadster", "lamborghini sc20", "sc20", "maserati grancabrio", "grancabrio cabriolet", "maserati spyder", "spyder cabriolet", "maserati grancabrio sport", "grancabrio sport", "mclaren 570s spider", "570s spider", "mclaren 720s spider", "720s spider", "mclaren artura spider", "artura spider", "mazda mx5", "mx5 cabriolet", "mazda miata", "miata cabriolet", "honda s2000", "s2000 cabriolet", "toyota mr2 spyder", "mr2 spyder", "nissan 370z roadster", "370z roadster", "nissan 240sx convertible", "240sx convertible", "bmw z4", "z4 cabriolet", "bmw z3", "z3 cabriolet", "bmw z1", "z1 cabriolet", "bmw z8", "z8 cabriolet"],
  "Monospace": ["monospace", "mpv", "minivan", "family van", "7 seater", "8 seater", "9 seater", "van", "people mover", "multi-purpose", "family vehicle", "renault espace", "espace", "renault grand scenic", "grand scenic", "renault scenic", "scenic", "renault megane scenic", "megane scenic", "renault modus", "modus", "renault grand modus", "grand modus", "peugeot 807", "807", "peugeot 5008", "5008", "peugeot 3008", "3008", "peugeot rifter", "rifter", "citroen c8", "c8", "citroen picasso", "c4 picasso", "c4 grand picasso", "citroen berlingo", "berlingo", "citroen berlingo multispace", "berlingo multispace", "citroen grand berlingo", "grand berlingo", "citroen xm", "xm", "fiat multipla", "multipla", "fiat ulysse", "ulysse", "fiat idea", "idea", "fiat 500l", "500l", "fiat 500x", "500x", "fiat doblò", "doblò", "doblò maxi", "doblò cargo", "doblò mixto", "fiat multipla", "fiat talento", "talento", "fiat scudo", "scudo", "fiat ducato", "ducato", "lancia lybra", "lybra", "lancia voyager", "voyager", "ford galaxy", "galaxy", "ford s-max", "s-max", "ford c-max", "c-max", "ford grand c-max", "grand c-max", "ford tourneo connect", "tourneo connect", "ford tourneo custom", "tourneo custom", "ford tourneo courier", "tourneo courier", "ford transit connect", "transit connect", "ford transit custom", "transit custom", "ford transit courier", "transit courier", "ford transit", "transit", "ford transit trail", "transit trail", "ford kuga", "kuga", "ford edge", "edge", "ford explorer", "explorer", "ford expedition", "expedition", "ford flex", "flex", "volkswagen transporter", "transporter", "volkswagen caravelle", "caravelle", "volkswagen multivan", "multivan", "volkswagen touran", "touran", "volkswagen sharan", "sharan", "volkswagen caddy", "caddy", "volkswagen caddy maxi", "caddy maxi", "volkswagen id.buzz", "id.buzz", "volkswagen t4", "t4", "volkswagen t5", "t5", "volkswagen t6", "t6", "volkswagen t6.1", "t6.1", "volkswagen t7", "t7", "hyundai h-1", "h-1", "hyundai i800", "i800", "hyundai h350", "h350", "hyundai santa fe", "santa fe", "hyundai palisade", "palisade", "hyundai venue", "venue", "kia carnival", "carnival", "kia carens", "carens", "kia niro", "niro", "kia sportage", "sportage", "kia sorento", "sorento", "kia sedona", "sedona", "kia pregio", "pregio", "kia bongo", "bongo", "mazda5", "5", "mazda8", "8", "mazda mpv", "mpv", "mazda premacy", "premacy", "mazda biante", "biante", "honda odyssey", "odyssey", "honda step wagon", "step wagon", "honda freed", "freed", "honda stream", "stream", "honda jade", "jade", "honda airwave", "airwave", "toyota sienna", "sienna", "toyota previa", "previa", "toyota estima", "estima", "toyota highlander", "highlander", "toyota sequoia", "sequoia", "toyota wish", "wish", "toyota alphard", "alphard", "toyota vellfire", "vellfire", "toyota granvia", "granvia", "toyota hiace", "hiace", "nissan quest", "quest", "nissan serena", "serena", "nissan elgrand", "elgrand", "nissan largo", "largo", "nissan teana", "teana", "nissan murano", "murano", "nissan pathfinder", "pathfinder", "mitsubishi delica", "delica", "mitsubishi grandis", "grandis", "mitsubishi outlander", "outlander", "subaru legacy", "legacy", "subaru exiga", "exiga", "volvo xc90", "xc90", "volvo v70", "v70", "volvo xc70", "xc70", "volvo v90", "v90", "volvo xc60", "xc60", "chevrolet venture", "venture", "chevrolet uplander", "uplander", "chevrolet traverse", "traverse", "chevrolet suburban", "suburban", "chevrolet tahoe", "tahoe", "chevrolet express", "express", "chrysler pacifica", "pacifica", "chrysler town & country", "town & country", "dodge caravan", "caravan", "dodge grand caravan", "grand caravan", "jeep grand cherokee", "grand cherokee"],
  "Utilitaire": ["utilitaire", "utility", "commercial", "work vehicle", "work van", "cargo", "box truck", "pickup", "truck", "light commercial", "lcv", "van", "transit", "cargo van", "delivery van", "panel van", "custom van", "crew cab", "double cab", "tipper", "flatbed", "tow truck", "dump truck", "articulated", "tractor unit", "tractor", "semi truck", "semi-truck", "lorry", "hgv", "artic", "volvo fh", "fh", "volvo fh12", "fh12", "volvo fh13", "fh13", "volvo fh16", "fh16", "volvo fm", "fm", "volvo fl", "fl", "volvo fe", "fe", "volvo ve", "ve", "scania r-series", "r-series", "scania r480", "r480", "scania r500", "r500", "scania r560", "r560", "scania r580", "r580", "scania r620", "r620", "scania r650", "r650", "scania p-series", "p-series", "scania g-series", "g-series", "man tgx", "tgx", "man tgm", "tgm", "man tgl", "tgl", "man tga", "tga", "man tgb", "tgb", "man tgs", "tgs", "man tgk", "tgk", "man tgp", "tgp", "daf xf", "xf", "daf cf", "cf", "daf lf", "lf", "renault premium", "premium", "renault magnum", "magnum", "renault manager", "manager", "renault midlum", "midlum", "renault mascott", "mascott", "renault maxity", "maxity", "renault master", "master", "renault trafic", "trafic", "renault kangoo", "kangoo", "renault express", "express", "renault scenic xmod", "scenic xmod", "iveco s-way", "s-way", "iveco stralis", "stralis", "iveco trakker", "trakker", "iveco daily", "daily", "iveco eurotech", "eurotech", "iveco eurocargo", "eurocargo", "mercedes arocs", "arocs", "mercedes actros", "actros", "mercedes antos", "antos", "mercedes atego", "atego", "mercedes axor", "axor", "mercedes ecos", "ecos", "mercedes l-series", "l-series", "mercedes sprinter", "sprinter", "mercedes vito", "vito", "mercedes t1", "t1", "mercedes t2", "t2", "mercedes lkw", "lkw", "hino 500 series", "500 series", "hino 300 series", "300 series", "hino 700 series", "700 series", "hino l-series", "l-series", "hino j-series", "j-series", "hino s-series", "s-series", "hino series 100", "series 100", "hino series 200", "series 200", "hino series 300", "series 300", "hino series 500", "series 500", "hino series 700", "series 700", "isuzu f-series", "f-series", "isuzu forward", "forward", "isuzu elf", "elf", "isuzu giga", "giga", "isuzu n-series", "n-series", "isuzu n-truck", "n-truck", "isuzu p-series", "p-series", "isuzu d-max", "d-max", "mitsubishi fuso", "fuso", "mitsubishi rosa", "rosa", "mitsubishi canter", "canter", "mitsubishi fighter", "fighter", "mitsubishi super great", "super great", "mitsubishi t-series", "t-series", "mitsubishi l-series", "l-series", "mitsubishi p-series", "p-series", "mitsubishi t120ss", "t120ss", "mitsubishi t160", "t160", "mitsubishi t200", "t200", "mitsubishi t220", "t220", "nissan ud", "ud", "nissan ud trucks", "ud trucks", "nissan atleon", "atleon", "nissan diesel", "diesel", "nissan quon", "quon", "nissan condor", "condor", "nissan clipper", "clipper", "nissan caravan", "caravan", "nissan e-caravan", "e-caravan", "nissan nv", "nv", "nissan nv100", "nv100", "nissan nv200", "nv200", "nissan nv350", "nv350", "nissan nv400", "nv400", "nissan nv3500", "nv3500", "isuzu", "isuzu truck", "hyundai xc series", "xc series", "hyundai hd series", "hd series", "hyundai universe", "universe", "hyundai mighty", "mighty", "kia granbird", "granbird", "kia spectra", "spectra", "kia commericial", "commericial", "daewoo novus", "novus", "daewoo ultra", "ultra", "daewoo prima", "prima", "fab motors", "ashok leyland", "leyland", "tata ace", "ace", "tata 407", "407", "tata 709", "709", "tata 909", "909", "tata bs-iii", "bs-iii", "tata bs-iv", "bs-iv", "tata prima", "prima", "tata signa", "signa", "atul auto", "bajaj commercial", "commercial", "force motors", "force", "mahindra commercial", "commercial", "swaraj", "eicher", "bharat benz", "benz", "bharat truck", "truck"]
};

function detectCategory(brand: string, model: string): string {
  const combined = `${brand} ${model}`.toLowerCase();
  
  // Check each category's keywords
  for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
    for (const keyword of keywords) {
      if (combined.includes(keyword.toLowerCase())) {
        return category;
      }
    }
  }
  
  // Default to Berline if no match
  return "Berline";
}

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL");
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

    if (!supabaseUrl || !supabaseKey) {
      return new Response(
        JSON.stringify({ success: false, error: "Supabase configuration missing" }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Fetch vehicles without categories
    const response = await fetch(`${supabaseUrl}/rest/v1/vehicles?select=id,brand,model&category=is.null&limit=1000`, {
      headers: {
        "Authorization": `Bearer ${supabaseKey}`,
        "apikey": supabaseKey,
        "Content-Type": "application/json",
      },
    });

    if (!response.ok) {
      throw new Error(`Supabase fetch failed: ${response.statusText}`);
    }

    const vehicles = await response.json();
    
    if (!Array.isArray(vehicles) || vehicles.length === 0) {
      return new Response(
        JSON.stringify({ success: true, message: "No vehicles without categories found", updated: 0 }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Assign categories and update
    let updated = 0;
    for (const vehicle of vehicles) {
      const category = detectCategory(vehicle.brand, vehicle.model);
      
      const updateResponse = await fetch(`${supabaseUrl}/rest/v1/vehicles?id=eq.${vehicle.id}`, {
        method: "PATCH",
        headers: {
          "Authorization": `Bearer ${supabaseKey}`,
          "apikey": supabaseKey,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ category }),
      });

      if (updateResponse.ok) {
        updated++;
        console.log(`Updated ${vehicle.brand} ${vehicle.model} (${vehicle.id}) -> ${category}`);
      } else {
        console.error(`Failed to update ${vehicle.id}: ${updateResponse.statusText}`);
      }
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        message: `Assigned categories to ${updated} vehicles`,
        updated,
        totalChecked: vehicles.length
      }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error) {
    console.error("Error assigning categories:", error);
    const errorMessage = error instanceof Error ? error.message : "Unknown error";
    return new Response(JSON.stringify({ success: false, error: errorMessage }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
